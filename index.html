<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</title>
  <link id="googleFontLink" rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap">
  <style>
    :root {
      --bg: #0b1220;
      --card: rgba(255,255,255,0.06);
      --card-strong: rgba(255,255,255,0.12);
      --text: #f7f9fc;
      --muted: #a8b3cf;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --danger: #f87171;
      --phase-athan: #60a5fa; /* Ø£Ø²Ø±Ù‚ */
      --phase-iqama: #fbbf24; /* Ø°Ù‡Ø¨ÙŠ */
      --phase-grace: #a8b3cf; /* Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø²Ø±Ù‚ */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg) center/cover no-repeat fixed; color: var(--text);
      font-family: Cairo, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display: grid; grid-template-rows: auto 1fr auto; min-height: 100vh;
      direction: rtl;
    }
    header {
      display:flex; gap:16px; align-items:center; justify-content:space-between;
      padding: 16px clamp(12px, 3vw, 32px);
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0));
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .brand .logo { width:40px; height:40px; border-radius:12px; background: var(--card-strong); display:grid; place-items:center; font-weight:800; }
    .brand h1 { font-size: clamp(18px, 2vw, 22px); margin: 0; font-weight: 700; letter-spacing: .3px; }
    .now { font-size: clamp(12px, 2vw, 14px); color: var(--muted); }

    .container { display:grid; grid-template-columns: 1fr; gap: 16px; padding: 0 clamp(12px, 3vw, 32px) 24px; }
    @media(min-width: 960px){ .container { grid-template-columns: 1.2fr .8fr; align-items:start; } }

    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(0,0,0,.25); }

    /* Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©) */
    .hero { padding: clamp(16px, 4vw, 32px); display:grid; gap: 16px; place-items:center; text-align:center; }
    .next-title { font-size: clamp(14px, 2.4vw, 16px); color: var(--muted); }
    .next-prayer { display:flex; align-items:baseline; justify-content:center; gap: 10px; }
    .next-prayer-name { font-size: clamp(28px, 6vw, 40px); font-weight: 800; letter-spacing: .3px; }
    .next-prayer-time { font-size: clamp(16px, 4vw, 24px); color: var(--accent); font-weight: 700; }

    .countdown { font-variant-numeric: tabular-nums; font-weight: 800; text-align:center; font-size: clamp(28px, 8vw, 60px); letter-spacing: .5px; }
    .phase { text-align:center; font-size: clamp(16px, 3.2vw, 28px); font-weight: 800; margin-top: -4px; color: var(--muted); }
    .phase.phase-athan{ color: var(--phase-athan); }
    .phase.phase-iqama{ color: var(--phase-iqama); }
    .phase.phase-grace{ color: var(--phase-grace); }

    .progress { height: 10px; background: rgba(255,255,255,0.08); border-radius: 999px; overflow:hidden; width: min(920px, 100%); }
    .bar { height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

    .grid { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px; width: min(920px, 100%); }
    @media(min-width:640px){ .grid { grid-template-columns: repeat(5, minmax(0,1fr)); } }
    .pill { text-align:center; padding: 10px; border-radius: 14px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); }
    .pill .label { color: var(--muted); font-size: 12px; }
    .pill .value { font-weight: 700; font-variant-numeric: tabular-nums; }

    .settings { padding: clamp(12px, 2.8vw, 20px); display:grid; gap: 14px; }
    .settings h2 { font-size: 18px; margin: 0 0 8px; }
    .row { display:grid; gap:10px; }
    @media(min-width:720px){ .row { grid-template-columns: 1fr 1fr; align-items:end; } }
    .field { display:grid; gap:6px; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="number"], input[type="time"], input[type="url"], input[type="file"], select, textarea {
      width:100%; padding: 10px 12px; background: rgba(255,255,255,0.06); color: var(--text);
      border: 1px solid rgba(255,255,255,0.14); border-radius: 12px; outline: none; font-size: 14px;
    }
    input[type="color"]{ padding:0; height: 40px; }
    button { appearance:none; border:none; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color:#06221a; padding: 10px 14px; font-weight:800; border-radius: 12px; cursor:pointer; box-shadow: 0 8px 20px rgba(0,0,0,.2); }
    button.ghost { background: rgba(255,255,255,0.06); color: var(--text); border:1px solid rgba(255,255,255,0.12); }
    button.danger { background: var(--danger); color: white; }
    .small { font-size: 12px; color: var(--muted); }

    table { width:100%; border-collapse: collapse; font-size: 13px; direction: rtl; }
    th, td { padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.08); text-align:start; }
    th { position: sticky; top:0; background: rgba(0,0,0,.25); backdrop-filter: blur(6px); }
    .table-wrap { max-height: 260px; overflow:auto; border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; }

    footer { padding: 10px clamp(12px, 3vw, 32px) 20px; display:flex; justify-content:space-between; align-items:center; gap:10px; color: var(--muted); font-size: 12px; }
    .stack { display:grid; gap:8px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .dropzone { border: 1.5px dashed rgba(255,255,255,0.35); border-radius: 12px; padding: 14px; text-align:center; background: rgba(255,255,255,0.04); }
    .hidden { display:none !important; }
    details { background: rgba(255,255,255,0.04); padding: 10px; border-radius: 12px; border:1px solid rgba(255,255,255,0.08); }
    summary { cursor: pointer; }
    pre { white-space: pre-wrap; word-break: break-word; background: rgba(0,0,0,.35); padding: 8px; border-radius: 8px; }

    /* ===== ÙˆØ¶Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ ===== */
    body.screen header { display: none; }
    body.screen footer { display: none; }
    body.screen .container { grid-template-columns: 1fr; padding: 20px; }
    body.screen #settings { display: none; }
    body.screen .hero { min-height: calc(100vh - 40px); display:grid; align-content:center; gap: 24px; }
    body.screen .next-prayer-name { font-size: clamp(36px, 8vw, 72px); }
    body.screen .countdown { font-size: clamp(40px, 12vw, 120px); }
    body.screen .next-prayer-time { font-size: clamp(18px, 4vw, 28px); }

    .floating-audio { position: fixed; inset-inline-start: 16px; inset-block-end: 16px; z-index: 1000; display:none; }
    body.screen .floating-audio.show { display:block; }
  </style>
  <!-- Firebase (Compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">ğŸ•°ï¸</div>
      <div>
        <h1>Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h1>
        <div class="now" id="now"></div>
      </div>
    </div>
    <div class="toolbar">
      <button id="enableAudioBtn" class="ghost">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
      <button id="openSettings" class="ghost">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button id="openScreen" class="ghost">Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶</button>
    </div>
  </header>

  <main class="container">
    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶ -->
    <section class="card hero" aria-live="polite">
      <div class="next-title">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
      <div class="next-prayer">
        <div class="next-prayer-name" id="nextPrayerName">â€”</div>
        <div class="next-prayer-time" id="nextPrayerClock">â€”</div>
      </div>
      <div class="countdown" id="countdown">00:00:00</div>
      <div class="phase" id="phase">Ø­ØªÙ‰ Ø§Ù„Ø£Ø°Ø§Ù†</div>
      <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
      <div class="grid" id="todayGrid"></div>
    </section>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <aside class="card settings" id="settings">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
      <div class="small">Ø§Ø±ÙØ¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø°Ø§Ù†ØŒ ÙˆØ§Ø¶Ø¨Ø· ÙØªØ±Ø§Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©ØŒ ÙˆØ§Ù„Ø£ØµÙˆØ§ØªØŒ ÙˆØ§Ù„Ø®Ù„ÙÙŠØ©ØŒ ÙˆØ§Ù„Ù…Ø¸Ù‡Ø±. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ØªÙØ­ÙÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙŠ IndexedDB. ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© (Firebase) Ø¨Ø§Ù„Ø£Ø³ÙÙ„.</div>

      <div class="row">
        <div class="field">
          <label>Ø±ÙØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (CSV Ø£Ùˆ JSON)</label>
          <div class="dropzone" id="dropzone">
            <div>Ø£Ø³Ù‚Ø· Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø®ØªØ±Ù‡</div>
            <input type="file" id="scheduleFile" accept=".csv,.json" />
          </div>
          <div class="small">Ø±Ø¤ÙˆØ³ CSV: <code>date,fajr,dhuhr,asr,maghrib,isha</code> Ø£Ùˆ <code>Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ÙØ¬Ø±,Ø§Ù„Ø¸Ù‡Ø±,Ø§Ù„Ø¹ØµØ±,Ø§Ù„Ù…ØºØ±Ø¨,Ø§Ù„Ø¹Ø´Ø§Ø¡</code> Â· Ø§Ù„ØªØ§Ø±ÙŠØ®: <code>YYYY-MM-DD</code>.</div>
        </div>
        <div class="field">
          <label>Ù…Ø¯Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø°Ø§Ù†)</label>
          <div class="grid">
            <div class="field"><label>Ø§Ù„ÙØ¬Ø±</label><input type="number" id="offFajr" min="0" step="1" value="20"></div>
            <div class="field"><label>Ø§Ù„Ø¸Ù‡Ø±</label><input type="number" id="offDhuhr" min="0" step="1" value="20"></div>
            <div class="field"><label>Ø§Ù„Ø¹ØµØ±</label><input type="number" id="offAsr" min="0" step="1" value="20"></div>
            <div class="field"><label>Ø§Ù„Ù…ØºØ±Ø¨</label><input type="number" id="offMaghrib" min="0" step="1" value="10"></div>
            <div class="field"><label>Ø§Ù„Ø¹Ø´Ø§Ø¡</label><input type="number" id="offIsha" min="0" step="1" value="30"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ÙØªØ±Ø© Ø³Ù…Ø§Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <input type="number" id="graceMin" min="0" step="1" value="8" />
          <div class="small">Ø®Ù„Ø§Ù„Ù‡Ø§ ØªØ¸Ù‡Ø± Ø¹Ø¨Ø§Ø±Ø© Â«Ø§Ù„ØµÙ„Ø§Ø© Ù‚Ø§Ø¦Ù…Ø©Â» Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø£Ø°Ø§Ù† Ø§Ù„ØªØ§Ù„ÙŠ.</div>
        </div>
        <div class="field"></div>
      </div>

      <div class="row">
        <div class="field">
          <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù†</label>
          <div class="grid">
            <div class="field"><label>Ù„ÙˆÙ† Ù…Ù…ÙŠØ²</label><input type="color" id="accent" value="#6ee7b7"></div>
            <div class="field"><label>Ù„ÙˆÙ† Ù…Ù…ÙŠØ² 2</label><input type="color" id="accent2" value="#60a5fa"></div>
            <div class="field"><label>Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©</label><input type="color" id="bg" value="#0b1220"></div>
            <div class="field"><label>Ù„ÙˆÙ† Ø§Ù„Ù†Øµ</label><input type="color" id="textColor" value="#f7f9fc"></div>
            <div class="field"><label>Ù„ÙˆÙ† "Ø­ØªÙ‰ Ø§Ù„Ø£Ø°Ø§Ù†"</label><input type="color" id="phaseAthanColor" value="#60a5fa"></div>
            <div class="field"><label>Ù„ÙˆÙ† "Ø­ØªÙ‰ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©"</label><input type="color" id="phaseIqamaColor" value="#fbbf24"></div>
            <div class="field"><label>Ù„ÙˆÙ† "Ø§Ù„ØµÙ„Ø§Ø© Ù‚Ø§Ø¦Ù…Ø©"</label><input type="color" id="phaseGraceColor" value="#a8b3cf"></div>
          </div>
        </div>
        <div class="field">
          <label>ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
          <input type="file" id="bgImage" accept="image/*" />
          <div class="toolbar">
            <button class="danger ghost" id="clearBg">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</button>
          </div>
          <div class="small">ØªÙØ­ÙÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ ÙˆÙŠÙ…ÙƒÙ† Ø±ÙØ¹Ù‡Ø§ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©.</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª</label>
          <select id="timeFormat">
            <option value="12" selected>12 Ø³Ø§Ø¹Ø©</option>
            <option value="24">24 Ø³Ø§Ø¹Ø©</option>
          </select>
          <label class="small">Ø¥Ø²Ø§Ø­Ø© Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
          <input type="number" id="tzOffset" placeholder="0" value="0">
        </div>
        <div class="field">
          <label>Ø±Ø§Ø¨Ø· Google Fonts (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="url" id="googleFontUrl" placeholder="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù† (MP3/WAV)</label>
          <input type="file" id="athanSound" accept="audio/*" />
          <div class="toolbar">
            <button class="ghost" id="testAthan">ØªØ¬Ø±Ø¨Ø©</button>
            <button class="danger ghost" id="clearAthan">Ø­Ø°Ù</button>
          </div>
        </div>
        <div class="field">
          <label>ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© (MP3/WAV)</label>
          <input type="file" id="iqamaSound" accept="audio/*" />
          <div class="toolbar">
            <button class="ghost" id="testIqama">ØªØ¬Ø±Ø¨Ø©</button>
            <button class="danger ghost" id="clearIqama">Ø­Ø°Ù</button>
          </div>
        </div>
      </div>

      <!-- ==== Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (Firebase) ==== -->
      <details open>
        <summary>Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© (Firebase)</summary>
        <div class="row">
          <div class="field">
            <label>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</label>
            <select id="cloudEnabled">
              <option value="off">Ù…ØªÙˆÙ‚ÙØ©</option>
              <option value="on">Ù…ÙØ¹Ù‘Ù„Ø©</option>
            </select>
            <div class="small">Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„/Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙˆØ±Ù‹Ø§.</div>
          </div>
          <div class="field">
            <label>Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù‚Ø§Ø¹Ø©/Ø§Ù„ØºØ±ÙØ© (Room ID)</label>
            <input type="text" id="roomId" placeholder="Ù…Ø«Ø§Ù„: main-hall" value="default" />
            <div class="small">Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±ÙÙ‹Ø§ Ù…Ù…ÙŠØ²Ù‹Ø§ Ù„Ù…Ø³Ø¬Ø¯Ùƒ. Ø´Ø§Ø±Ùƒ Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶.</div>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>apiKey</label>
            <input type="text" id="fb_apiKey" placeholder="AIza..." />
          </div>
          <div class="field">
            <label>authDomain</label>
            <input type="text" id="fb_authDomain" placeholder="yourapp.firebaseapp.com" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>databaseURL (Realtime DB)</label>
            <input type="text" id="fb_databaseURL" placeholder="https://yourapp-default-rtdb.firebaseio.com" />
          </div>
          <div class="field">
            <label>storageBucket</label>
            <input type="text" id="fb_storageBucket" placeholder="yourapp.appspot.com" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ù„Ù„Ù…Ø´Ø±Ù)</label>
            <input type="text" id="fb_email" placeholder="admin@example.com" />
          </div>
          <div class="field">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="fb_password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
        </div>
        <div class="toolbar">
          <button id="fbConnect">Ø±Ø¨Ø·/ØªÙ‡ÙŠØ¦Ø© Firebase</button>
          <button id="fbLogin" class="ghost">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <button id="fbLogout" class="ghost">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
          <button id="fbTest" class="ghost">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
        </div>
        <div class="small">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="cloudStatus">ØºÙŠØ± Ù…ØªØµÙ„</span></div>
      </details>

      <div class="toolbar" style="margin-top:8px;">
        <button id="saveSettings">Ø­ÙØ¸</button>
        <button id="exportData" class="ghost">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <button id="exportWithMedia" class="ghost">ØªØµØ¯ÙŠØ± Ù…Ø¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</button>
        <button id="importData" class="ghost">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        <button id="resetAll" class="danger">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„ÙƒÙ„ÙŠ</button>
        <button id="pushAll" class="ghost">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙ„ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ø¢Ù†</button>
        <button id="pullAll" class="ghost">Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
      </div>

      <details>
        <summary>Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø± ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</summary>
        <div class="toolbar" style="margin-top:8px;">
          <button id="runTests" class="ghost">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
          <button id="showUsage" class="ghost">Ø¹Ø±Ø¶ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ†</button>
          <button id="clearIDB" class="danger ghost">Ù…Ø³Ø­ IndexedDB</button>
        </div>
        <pre id="testOutput" class="small"></pre>
      </details>

      <div class="stack">
        <div class="small">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ù…Ù‘Ù„</div>
        <div class="table-wrap">
          <table id="scheduleTable">
            <thead>
              <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙØ¬Ø±</th><th>Ø§Ù„Ø¸Ù‡Ø±</th><th>Ø§Ù„Ø¹ØµØ±</th><th>Ø§Ù„Ù…ØºØ±Ø¨</th><th>Ø§Ù„Ø¹Ø´Ø§Ø¡</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </aside>
  </main>

  <footer>
    <div>Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù†Ù‚Ø± Â«ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØªÂ» Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ÙÙŠ Ø§Ù„Ù…ØªØµÙÙ‘Ø­.</div>
    <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Â· <span id="status">Ø¬Ø§Ù‡Ø²</span></div>
  </footer>

  <!-- Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ÙÙŠ ÙˆØ¶Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ -->
  <div class="floating-audio" id="floatingAudio">
    <button id="enableAudioFloating">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
  </div>

  <audio id="audioAthan" preload="auto"></audio>
  <audio id="audioIqama" preload="auto"></audio>

  <script>
  // ======= Ø«ÙˆØ§Ø¨Øª ÙˆÙ…Ø³Ø§Ø¹Ø¯Ø§Øª =======
  const PRAYERS = ["Fajr","Dhuhr","Asr","Maghrib","Isha"];
  const DISPLAY = {Fajr:"Ø§Ù„ÙØ¬Ø±", Dhuhr:"Ø§Ù„Ø¸Ù‡Ø±", Asr:"Ø§Ù„Ø¹ØµØ±", Maghrib:"Ø§Ù„Ù…ØºØ±Ø¨", Isha:"Ø§Ù„Ø¹Ø´Ø§Ø¡"};
  const el = id => document.getElementById(id);
  const status = msg => { const s = el('status'); if(s) s.textContent = msg; };
  const pad = n => n.toString().padStart(2,'0');
  const qs = new URLSearchParams(location.search);
  const SCREEN = qs.get('screen') === '1' || qs.has('screen');
  const AUTO_AUDIO = qs.get('autoplay') === '1' || qs.get('autoaudio') === '1';


  // ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¢Ù† Ù„Ù„Ù†Øµ Ø§Ù„Ø¹Ù„ÙˆÙŠ
  function nowString(){
    const d = new Date();
    const yyyy = d.getFullYear(); const mm = pad(d.getMonth()+1); const dd = pad(d.getDate());
    let h = d.getHours(); const ap = h>=12 ? 'Ù…' : 'Øµ'; h = h%12 || 12;
    const mi = pad(d.getMinutes()); const ss = pad(d.getSeconds());
    return `Ø§Ù„Ø¢Ù†: ${yyyy}-${mm}-${dd} ${h}:${mi}:${ss} ${ap}`;
  }

// ØªØ­Ù„ÙŠÙ„ ÙˆÙ‚Øª (ÙŠØ¯Ø¹Ù… 12/24 Ùˆ Øµ/Ù…)
function parseTimeToDate(dateStr, timeStr, tzOffsetMin=0){
  if(!timeStr) return null;

  // Ø·Ø¨Ù‘Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ ÙˆØ­ÙˆÙ‘Ù„ Øµ/Ù… Ø¥Ù„Ù‰ AM/PM
  const arDigits = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
  let s = (''+timeStr).trim()
    .replace(/[Ù -Ù©]/g, d => String(arDigits.indexOf(d)))
    .replace(/\s*Øµ\s*$/i, ' AM')
    .replace(/\s*Ù…\s*$/i, ' PM');

  // Ø·Ø§Ø¨Ù‚ hh:mm Ù…Ø¹ Ù„Ø§Ø­Ù‚Ø© AM/PM Ø¥Ù† ÙˆÙØ¬Ø¯Øª
  const m = s.match(/^(\d{1,2}):(\d{2})(?:\s*(AM|PM))?$/i);
  if(!m) return null;

  let h = parseInt(m[1],10), min = parseInt(m[2],10);
  const ap = m[3] ? m[3].toUpperCase() : null;
  if(ap){
    if(ap==='PM' && h!==12) h += 12;
    if(ap==='AM' && h===12) h = 0;
  }

  const d = new Date(dateStr + 'T' + String(h).padStart(2,'0') + ':' + String(min).padStart(2,'0') + ':00');
  if(tzOffsetMin){ d.setMinutes(d.getMinutes() + tzOffsetMin); }
  return d;
}



  function fmtClock(date, mode){
    if(!(date instanceof Date)) return 'â€”';
    let h = date.getHours(); let m = date.getMinutes();
    if(mode==='12'){ const ap = h>=12 ? 'Ù…':'Øµ'; h = h%12 || 12; return `${h}:${pad(m)} ${ap}`; }
    return `${pad(h)}:${pad(m)}`;
  }

  function fmtDuration(ms){
    if(ms<0) ms=0; const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600); const mm = Math.floor((s%3600)/60); const ss = s%60;
    return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
  }

  function loadLS(key, fallback){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch{ return fallback; } }
  function saveLS(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){ console.warn('LocalStorage save failed', key, e); if(e && (e.name==='QuotaExceededError'||e.code===22)) alert('Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù…Ù…ØªÙ„Ø¦.'); } }

  // ======= IndexedDB Ù„Ù„ÙˆØ³Ø§Ø¦Ø· =======
  let dbPromise = null;
  function getDB(){ if(dbPromise) return dbPromise; dbPromise = new Promise((resolve,reject)=>{ const open=indexedDB.open('ptt_db',1); open.onupgradeneeded=()=>{ const db=open.result; if(!db.objectStoreNames.contains('files')) db.createObjectStore('files'); }; open.onsuccess=()=>resolve(open.result); open.onerror=()=>reject(open.error); }); return dbPromise; }
  async function idbSet(key, blob){ const db=await getDB(); return new Promise((res,rej)=>{ const tx=db.transaction('files','readwrite'); tx.objectStore('files').put(blob,key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
  async function idbGet(key){ const db=await getDB(); return new Promise((res,rej)=>{ const tx=db.transaction('files','readonly'); const rq=tx.objectStore('files').get(key); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>rej(rq.error); }); }
  async function idbDelete(key){ const db=await getDB(); return new Promise((res,rej)=>{ const tx=db.transaction('files','readwrite'); tx.objectStore('files').delete(key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
  async function idbClear(){ const db=await getDB(); return new Promise((res,rej)=>{ const tx=db.transaction('files','readwrite'); tx.objectStore('files').clear(); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); }); }
  function dataURLtoBlob(dataURL){ try{ const [meta,b64]=dataURL.split(','); const mime=(meta.match(/data:(.*?);base64/)||[])[1]||'application/octet-stream'; const bin=atob(b64); const len=bin.length; const arr=new Uint8Array(len); for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i); return new Blob([arr],{type:mime}); }catch(e){ console.warn('dURL->Blob failed',e); return null; } }
  function blobToDataURL(blob){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error); fr.readAsDataURL(blob); }); }

  // ======= Sanitizers =======
  const INVALID_KEY_CHARS = /[.#$/\[\]]/g; // Ù…Ù…Ù†ÙˆØ¹Ø© ÙÙŠ RTDB
  function sanitizeDateKey(k){
    if(!k) return null;
    const s = String(k).trim();
    // Ø§Ù„ØªÙ‚Ø· Ø£ÙˆÙ„ ØªØ·Ø§Ø¨Ù‚ Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© yyyy-mm-dd Ø£Ùˆ yyyy/mm/dd Ø£Ùˆ Ù…Ø¹ Ù…Ø³Ø§ÙØ§Øª/Ù†Ù‚Ø§Ø·
    const m = s.match(/(\d{4})[\-\/_\.\s](\d{2})[\-\/_\.\s](\d{2})/);
    if(!m) return null;
    const y=m[1], mo=m[2], d=m[3];
    const iso = `${y}-${mo}-${d}`.replace(INVALID_KEY_CHARS,'');
    return iso;
  }
  function sanitizeScheduleForFirebase(sch){
    const out={};
    for(const k of Object.keys(sch||{})){
      const nk = sanitizeDateKey(k);
      if(!nk) continue; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©
      out[nk] = sch[k];
    }
    return out;
  }

  // ======= Ø§Ù„Ø­Ø§Ù„Ø© =======
  const state = {
    schedule: loadLS('ptt_schedule', {}),
    offsets: loadLS('ptt_offsets', {Fajr:20,Dhuhr:20,Asr:20,Maghrib:10,Isha:30}),
    audioFlags: loadLS('ptt_audioFlags', {athan:false, iqama:false}),
    ui: loadLS('ptt_ui', { font:"Cairo, system-ui, -apple-system, Segoe UI, Roboto, sans-serif", googleFontUrl:"", colors:{accent:'#6ee7b7', accent2:'#60a5fa', bg:'#0b1220', text:'#f7f9fc', phaseAthan:'#60a5fa', phaseIqama:'#fbbf24', phaseGrace:'#a8b3cf'}, bgImageKey:null, timeFormat:'12', tzOffset:0, graceMin:8 }),
    audioEnabled: false,
    phase: 'athan', // 'athan' | 'iqama' | 'grace'
    next: null,
    cloud: loadLS('ptt_cloud', {enabled:false, roomId:'default', config:{}, signedIn:false})
  };

  // ======= ØªØ±Ø­ÙŠÙ„ Ù‚Ø¯ÙŠÙ… =======
  async function migrateIfNeeded(){
    const oldA = localStorage.getItem('ptt_audioAthan'); if(oldA && oldA.startsWith('data:')){ const b=dataURLtoBlob(oldA); if(b) await idbSet('ptt_audioAthan', b); localStorage.removeItem('ptt_audioAthan'); }
    const oldQ = localStorage.getItem('ptt_audioIqama'); if(oldQ && oldQ.startsWith('data:')){ const b=dataURLtoBlob(oldQ); if(b) await idbSet('ptt_audioIqama', b); localStorage.removeItem('ptt_audioIqama'); }
    if(state.ui && state.ui.bgImage && state.ui.bgImage.startsWith?.('data:')){ const b=dataURLtoBlob(state.ui.bgImage); if(b){ await idbSet('ptt_bgImage', b); state.ui.bgImageKey='ptt_bgImage'; delete state.ui.bgImage; saveLS('ptt_ui', state.ui); } }
  }

  // ======= Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… =======
  function renderTable(){ const tb = el('scheduleTable')?.querySelector('tbody'); if(!tb) return; tb.innerHTML=''; const dates=Object.keys(state.schedule).sort(); for(const d of dates){ const r=state.schedule[d]; const tr=document.createElement('tr'); tr.innerHTML = `<td>${d}</td>` + PRAYERS.map(p=>`<td>${r[p]||'â€”'}</td>`).join(''); tb.appendChild(tr); } }
  function renderTodayPills(){ const grid = el('todayGrid'); if(!grid) return; grid.innerHTML=''; const todayKey=toKey(todayLocal()); const row=state.schedule[todayKey]; for(const p of PRAYERS){ const div=document.createElement('div'); div.className='pill'; const timeStr=row?row[p]:'â€”'; const dt=row?parseTimeToDate(todayKey, timeStr, state.ui.tzOffset):null; div.innerHTML = `<div class="label">${DISPLAY[p]}</div><div class="value">${fmtClock(dt||'â€”', state.ui.timeFormat)}</div>`; grid.appendChild(div); } }

  // ======= Ø®Ù„ÙÙŠØ© =======
  let bgUrl = null; async function loadBgFromStore(){ try{ const blob=await idbGet('ptt_bgImage'); if(bgUrl){ URL.revokeObjectURL(bgUrl); bgUrl=null; } if(blob){ bgUrl=URL.createObjectURL(blob); document.body.style.backgroundImage=`url(${bgUrl})`; } else { document.body.style.backgroundImage=''; } }catch(e){ console.warn('load bg failed',e); } }

  // ======= ÙˆÙ‚Øª ÙˆÙ…Ù†Ø·Ù‚ =======
  function todayLocal(){ const n=new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); }
  function toKey(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function findNext(){
    const now = new Date(); const todayKey=toKey(todayLocal()); const todayRow=state.schedule[todayKey];
    const sequence=[];
    if(todayRow){ for(const p of PRAYERS){ const t=todayRow[p]; if(!t) continue; const athanAt=parseTimeToDate(todayKey,t,state.ui.tzOffset); const off=state.offsets[p]||0; const iqamaAt=new Date(athanAt.getTime()+off*60000); sequence.push({day:todayKey,prayerName:p,athanAt,iqamaAt}); } }
    const nextDay=new Date(todayLocal()); nextDay.setDate(nextDay.getDate()+1); const nextKey=toKey(nextDay); const nextRow=state.schedule[nextKey];
    if(nextRow){ for(const p of PRAYERS){ const t=nextRow[p]; if(!t) continue; const athanAt=parseTimeToDate(nextKey,t,state.ui.tzOffset); const off=state.offsets[p]||0; const iqamaAt=new Date(athanAt.getTime()+off*60000); sequence.push({day:nextKey,prayerName:p,athanAt,iqamaAt}); } }
    const nowMs=now.getTime();
    for(const item of sequence){ const graceEnd=new Date(item.iqamaAt.getTime()+(state.ui.graceMin||0)*60000); if(nowMs < item.athanAt.getTime()){ state.phase='athan'; return item; } if(nowMs>=item.athanAt.getTime() && nowMs<item.iqamaAt.getTime()){ state.phase='iqama'; return item; } if(nowMs>=item.iqamaAt.getTime() && nowMs<graceEnd.getTime()){ state.phase='grace'; return item; } }
    return sequence[0]||null;
  }
  function setPhaseVisuals(){ const ph = el('phase'); if(!ph) return; ph.classList.remove('phase-athan','phase-iqama','phase-grace'); if(state.phase==='athan') ph.classList.add('phase-athan'); else if(state.phase==='iqama') ph.classList.add('phase-iqama'); else ph.classList.add('phase-grace'); }

  let timer=null; let lastPhaseKey='';
  function start(){
    if(timer) clearInterval(timer);
    loadAudios(); renderTable(); renderTodayPills();
    timer = setInterval(()=>{
      const nowEl=el('now'); if(nowEl) nowEl.textContent = nowString();
      const now = new Date(); const next = findNext(); state.next=next;
      if(!next){ el('nextPrayerName').textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯'; el('nextPrayerClock').textContent='â€”'; el('countdown').textContent='â€”'; el('phase').textContent='Ø§Ø±ÙØ¹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ù„Ø¨Ø¯Ø¡'; el('bar').style.width='0%'; return; }
      const name=next.prayerName; const athanAt=next.athanAt; const iqamaAt=next.iqamaAt; const graceEnd=new Date(iqamaAt.getTime()+(state.ui.graceMin||0)*60000);
      const target=(state.phase==='athan')?athanAt:(state.phase==='iqama'?iqamaAt:graceEnd); const until=target.getTime()-now.getTime();
      el('nextPrayerName').textContent = DISPLAY[name]||name;
      el('nextPrayerClock').textContent = fmtClock(athanAt, state.ui.timeFormat);
      el('phase').textContent = state.phase==='athan' ? 'Ø­ØªÙ‰ Ø§Ù„Ø£Ø°Ø§Ù†' : (state.phase==='iqama' ? 'Ø­ØªÙ‰ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©' : 'Ø§Ù„ØµÙ„Ø§Ø© Ù‚Ø§Ø¦Ù…Ø©'); setPhaseVisuals();
      el('countdown').textContent = fmtDuration(until);
      let totalPhase=0, elapsed=0;
      if(state.phase==='athan'){ const MAX=90*60000; totalPhase=MAX; elapsed=Math.min(MAX, Math.max(0, MAX-until)); }
      else if(state.phase==='iqama'){ totalPhase=iqamaAt.getTime()-athanAt.getTime(); elapsed=Math.max(0, Math.min(totalPhase, (now.getTime()-athanAt.getTime()))); }
      else { totalPhase=graceEnd.getTime()-iqamaAt.getTime(); elapsed=Math.max(0, Math.min(totalPhase, (now.getTime()-iqamaAt.getTime()))); }
      const pct = totalPhase>0 ? (elapsed/totalPhase)*100 : 0; el('bar').style.width = pct.toFixed(1)+'%';
      const key = `${name}-${state.phase}`;
      if(until<=0){
        if(lastPhaseKey!==key){ if(state.audioEnabled){ try{ if(state.phase==='athan') { audioAthan.currentTime=0; audioAthan.play(); } if(state.phase==='iqama'){ audioIqama.currentTime=0; audioIqama.play(); } }catch(e){} } }
        if(state.phase==='athan'){ state.phase='iqama'; }
        else if(state.phase==='iqama'){ state.phase='grace'; }
        else { state.phase='athan'; const _=findNext(); }
      }
      lastPhaseKey=key;
    }, 250);
  }

  // ======= Ù‚Ø±Ø§Ø¡Ø© CSV/JSON =======
  function parseCSV(text){
    const lines=text.replace(/\r/g,'').trim().split(/\n+/);
    if(lines.length===0) return {};
    const header=lines[0].split(',').map(h=>h.trim().toLowerCase());
    const findIdx=(keys)=>{ for(const k of keys){ const i=header.indexOf(k); if(i!==-1) return i; } return -1; };
    const idx = { date:findIdx(['date','Ø§Ù„ØªØ§Ø±ÙŠØ®']), fajr:findIdx(['fajr','Ø§Ù„ÙØ¬Ø±']), dhuhr:findIdx(['dhuhr','Ø§Ù„Ø¸Ù‡Ø±']), asr:findIdx(['asr','Ø§Ù„Ø¹ØµØ±']), maghrib:findIdx(['maghrib','Ø§Ù„Ù…ØºØ±Ø¨']), isha:findIdx(['isha','Ø§Ù„Ø¹Ø´Ø§Ø¡']) };
    const out={};
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(',').map(c=>c.trim());
      const rawDate=cols[idx.date];
      const date=sanitizeDateKey(rawDate);
      if(!date) continue;
      out[date] = {
        Fajr:cols[idx.fajr]||'',
        Dhuhr:cols[idx.dhuhr]||'',
        Asr:cols[idx.asr]||'',
        Maghrib:cols[idx.maghrib]||'',
        Isha:cols[idx.isha]||''
      };
    }
    return out;
  }

  function handleScheduleFile(file){
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        let data={};
        if(file.name.toLowerCase().endsWith('.json')){
          const obj=JSON.parse(reader.result);
          if(Array.isArray(obj)){
            for(const r of obj){
              const rawDate=r.date||r['Ø§Ù„ØªØ§Ø±ÙŠØ®'];
              const date=sanitizeDateKey(rawDate);
              if(!date) continue;
              data[date] = {
                Fajr:r.fajr||r['Ø§Ù„ÙØ¬Ø±']||'',
                Dhuhr:r.dhuhr||r['Ø§Ù„Ø¸Ù‡Ø±']||'',
                Asr:r.asr||r['Ø§Ù„Ø¹ØµØ±']||'',
                Maghrib:r.maghrib||r['Ø§Ù„Ù…ØºØ±Ø¨']||'',
                Isha:r.isha||r['Ø§Ù„Ø¹Ø´Ø§Ø¡']||''
              };
            }
          } else {
            for(const k of Object.keys(obj)){
              const date=sanitizeDateKey(k);
              if(!date) continue;
              const r=obj[k];
              data[date]={
                Fajr:r.Fajr||r.fajr||r['Ø§Ù„ÙØ¬Ø±']||'',
                Dhuhr:r.Dhuhr||r.dhuhr||r['Ø§Ù„Ø¸Ù‡Ø±']||'',
                Asr:r.Asr||r.asr||r['Ø§Ù„Ø¹ØµØ±']||'',
                Maghrib:r.Maghrib||r.maghrib||r['Ø§Ù„Ù…ØºØ±Ø¨']||'',
                Isha:r.Isha||r.isha||r['Ø§Ù„Ø¹Ø´Ø§Ø¡']||''
              };
            }
          }
        } else {
          data = parseCSV(reader.result);
        }
        // Ø¯Ù…Ø¬ ÙˆØ­ÙØ¸ Ù…Ø­Ù„ÙŠ
        state.schedule = {...sanitizeScheduleForFirebase(state.schedule), ...data};
        saveLS('ptt_schedule', state.schedule);
        renderTable(); renderTodayPills();
        status('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
        // Ø¯ÙØ¹ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØ¹Ù‘Ù„Ø©
        if(state.cloud.enabled) {
          pushToCloud({schedule:true}).then(ok=>{ if(ok) status('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©'); });
        }
      }catch(e){
        alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„: '+e.message);
      }
    };
    reader.readAsText(file);
  }

  // ======= Ø§Ù„ØµÙˆØª/Ø§Ù„Ø«ÙŠÙ… =======
  const audioAthan = el('audioAthan'); const audioIqama = el('audioIqama'); let athanUrl=null, iqamaUrl=null;
  async function loadAudios(){ try{ const a=await idbGet('ptt_audioAthan'); if(athanUrl){ URL.revokeObjectURL(athanUrl); athanUrl=null; } if(a){ athanUrl=URL.createObjectURL(a); audioAthan.src=athanUrl; state.audioFlags.athan=true; } else { audioAthan.removeAttribute('src'); state.audioFlags.athan=false; } const q=await idbGet('ptt_audioIqama'); if(iqamaUrl){ URL.revokeObjectURL(iqamaUrl); iqamaUrl=null; } if(q){ iqamaUrl=URL.createObjectURL(q); audioIqama.src=iqamaUrl; state.audioFlags.iqama=true; } else { audioIqama.removeAttribute('src'); state.audioFlags.iqama=false; } saveLS('ptt_audioFlags', state.audioFlags); }catch(e){ console.warn('loadAudios failed',e); } }
  function enableAudio(){ state.audioEnabled=true; [audioAthan,audioIqama].forEach(a=>{ a.muted=true; a.play().catch(()=>{}).finally(()=>{ a.pause(); a.currentTime=0; a.muted=false; }); }); status('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª'); updateFloatingAudio(); }
  function updateFloatingAudio(){ const fa=el('floatingAudio'); if(!fa) return; if(SCREEN && !state.audioEnabled) fa.classList.add('show'); else fa.classList.remove('show'); }

  function applyTheme(){ document.body.style.setProperty('--accent', state.ui.colors.accent); document.body.style.setProperty('--accent-2', state.ui.colors.accent2); document.body.style.setProperty('--bg', state.ui.colors.bg); document.body.style.setProperty('--text', state.ui.colors.text); document.body.style.setProperty('--phase-athan', state.ui.colors.phaseAthan||'#60a5fa'); document.body.style.setProperty('--phase-iqama', state.ui.colors.phaseIqama||'#fbbf24'); document.body.style.setProperty('--phase-grace', state.ui.colors.phaseGrace||'#a8b3cf'); document.body.style.fontFamily = state.ui.font; if(state.ui.googleFontUrl){ el('googleFontLink').href = state.ui.googleFontUrl; } loadBgFromStore(); }

  // ======= URL Params (Cloud Auto-Config) =======
  function normalizeBucket(b){ if(!b) return b; return /\.firebasestorage\.app$/i.test(b) ? b.replace(/\.firebasestorage\.app$/i, '.appspot.com') : b; }
  function applyUrlParams(params){
    try{
      const p = params || new URLSearchParams(location.search);
      const c = (p.get('cloud')||p.get('sync')||'').toLowerCase();
      if(c && c !== '0' && c !== 'false') state.cloud.enabled = true;
      const room = p.get('room') || p.get('r'); if(room) state.cloud.roomId = room;
      const cfg = {...(state.cloud.config||{})};
      const map = { apiKey:['apiKey','fb_apiKey'], authDomain:['authDomain','fb_authDomain'], databaseURL:['databaseURL','fb_databaseURL'], storageBucket:['storageBucket','fb_storageBucket'] };
      for(const k in map){ for(const key of map[k]){ const v = p.get(key); if(v){ cfg[k]=v; break; } } }
      if(cfg.storageBucket) cfg.storageBucket = normalizeBucket(cfg.storageBucket);
      if(Object.keys(cfg).length) state.cloud.config = cfg;
      const email = p.get('email'); const pass = p.get('password') || p.get('pass');
      if(email && pass){ state.cloud.email=email; state.cloud.password=pass; }
      saveLS('ptt_cloud', state.cloud);
    }catch(e){ console.warn('URL params apply failed', e); }
  }

  // ======= Firebase Sync =======
  let fb={app:null, auth:null, db:null, storage:null, unsub:null};
  function cloudStatus(msg){ const x=el('cloudStatus'); if(x) x.textContent = msg; }
  function getRoomPath(){ const room = (state.cloud.roomId||'default').replace(/[^a-zA-Z0-9_-]/g,'-'); return `rooms/${room}`; }
  function getRefs(){ const base=getRoomPath(); return { base, schedule:`${base}/schedule`, offsets:`${base}/offsets`, ui:`${base}/ui`, media:`${base}/media`}; }

  function initFirebase(){
    try{
      if(!state.cloud.config || !state.cloud.config.apiKey){ alert('Ø£Ø¯Ø®Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø£ÙˆÙ„Ù‹Ø§'); return false; }
      if(!fb.app){ fb.app = firebase.initializeApp(state.cloud.config); fb.auth=firebase.auth(); fb.db=firebase.database(); fb.storage=firebase.storage(); }
      cloudStatus('Ø¬Ø§Ù‡Ø² (ØºÙŠØ± Ù…Ø³Ø¬Ù„)');
      return true;
    }catch(e){ alert('ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase: '+e.message); cloudStatus('ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©'); return false; }
  }

  async function fbLogin(){ try{ if(!initFirebase()) return; const {email,password} = state.cloud; await fb.auth.signInWithEmailAndPassword(email, password); cloudStatus('Ù…ØªØµÙ„ ÙˆÙ…ÙØ³Ø¬Ù‘Ù„'); state.cloud.signedIn=true; saveLS('ptt_cloud', state.cloud); if(state.cloud.enabled) subscribeCloud(); }catch(e){ alert('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙØ´Ù„: '+e.message); cloudStatus('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); } }
  async function fbLogout(){ try{ if(fb.auth) await fb.auth.signOut(); state.cloud.signedIn=false; saveLS('ptt_cloud', state.cloud); cloudStatus('ØºÙŠØ± Ù…ØªØµÙ„'); if(fb.unsub){ fb.unsub(); fb.unsub=null; } }catch(e){} }

  function subscribeCloud(){
    if(!initFirebase()) return; if(fb.unsub){ fb.unsub(); fb.unsub=null; }
    const r=getRefs(); cloudStatus('Ù…ØªØµÙ„ (Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±)');
    const on = (path, handler)=> fb.db.ref(path).on('value', snap=>{ const val=snap.val(); if(val==null) return; handler(val); });
    on(r.schedule, (v)=>{ state.schedule=sanitizeScheduleForFirebase(v); saveLS('ptt_schedule', state.schedule); renderTable(); renderTodayPills(); });
    on(r.offsets,  (v)=>{ state.offsets=v; saveLS('ptt_offsets', v); });
    on(r.ui,       (v)=>{ state.ui={...state.ui,...v}; saveLS('ptt_ui', state.ui); applyTheme(); renderTodayPills(); });
    on(r.media,    async (v)=>{
      if(v.athanUrl){ audioAthan.src = v.athanUrl; }
      if(v.iqamaUrl){ audioIqama.src = v.iqamaUrl; }
      if(v.bgUrl){ document.body.style.backgroundImage = `url(${v.bgUrl})`; }
    });
    fb.unsub = ()=>{ fb.db.ref(r.schedule).off(); fb.db.ref(r.offsets).off(); fb.db.ref(r.ui).off(); fb.db.ref(r.media).off(); cloudStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„'); };
  }

  function pushToCloud({schedule=false, offsets=false, ui=false}={}){
    if(!state.cloud.enabled) { cloudStatus('Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…ØªÙˆÙ‚ÙØ©'); return Promise.resolve(false); }
    if(!initFirebase()) { cloudStatus('Firebase ØºÙŠØ± Ù…Ù‡ÙŠÙ‘Ø£'); return Promise.resolve(false); }
    if(!fb || !fb.db || typeof fb.db.ref !== 'function'){ cloudStatus('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©'); return Promise.resolve(false); }
    // Ù†Ø¸Ù‘Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹
    const cleanSchedule = sanitizeScheduleForFirebase(state.schedule);
    state.schedule = cleanSchedule; // Ø­Ø§ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ø¸ÙŠÙØ©
    saveLS('ptt_schedule', state.schedule);

    const r=getRefs(); const updates={};
    if(schedule) updates[r.schedule] = cleanSchedule;
    if(offsets)  updates[r.offsets]  = state.offsets;
    if(ui)       updates[r.ui]       = state.ui;
    if(!Object.keys(updates).length) return Promise.resolve(true);
    cloudStatus('ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...');
    return fb.db.ref().update(updates)
      .then(()=>{ cloudStatus('ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return true; })
      .catch(e=>{ console.warn('push failed',e); cloudStatus('ÙØ´Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø©: '+(e?.code||e?.message||e)); alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:\n'+(e?.message||e)); return false; });
  }

  async function uploadToStorage(file, key){
    try{
      if(!initFirebase()) return null; if(!fb.storage) return null;
      const room = (state.cloud.roomId||'default').replace(/[^a-zA-Z0-9_-]/g,'-');
      const path = `rooms/${room}/${key}`;
      const ref = fb.storage.ref().child(path);
      const snap = await ref.put(file);
      const url = await snap.ref.getDownloadURL();
      await fb.db.ref(getRefs().media).update({[key+'Url']: url});
      cloudStatus('Ù…Ø±ÙÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
      return url;
    }catch(e){ alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ø³Ø­Ø§Ø¨Ø©: '+e.message); return null; }
  }

  // ======= Ø±Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =======
  function initControls(){
    // Ø±ÙØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    el('scheduleFile').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) handleScheduleFile(f); });
    const drop = el('dropzone'); drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='rgba(255,255,255,0.08)';}); drop.addEventListener('dragleave', e=>{ drop.style.background='rgba(255,255,255,0.04)';}); drop.addEventListener('drop', e=>{ e.preventDefault(); drop.style.background='rgba(255,255,255,0.04)'; const f=e.dataTransfer.files?.[0]; if(f) handleScheduleFile(f); });

    // offsets
    const map = {Fajr:'offFajr', Dhuhr:'offDhuhr', Asr:'offAsr', Maghrib:'offMaghrib', Isha:'offIsha'}; for(const p of PRAYERS){ el(map[p]).value = state.offsets[p] ?? 0; }
    el('graceMin').value = state.ui.graceMin ?? 8;

    // Ø§Ù„ØµÙˆØª
    el('athanSound').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ await idbSet('ptt_audioAthan', f); await loadAudios(); status('ØªÙ… ØªØ¹ÙŠÙŠÙ† ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù†'); if(state.cloud.enabled) await uploadToStorage(f, 'athan'); } catch(err){ alert('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸/Ø±ÙØ¹ ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù†.'); } });
    el('iqamaSound').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ await idbSet('ptt_audioIqama', f); await loadAudios(); status('ØªÙ… ØªØ¹ÙŠÙŠÙ† ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©'); if(state.cloud.enabled) await uploadToStorage(f, 'iqama'); } catch(err){ alert('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸/Ø±ÙØ¹ ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©.'); } });
    el('testAthan').onclick = ()=>{ if(state.audioEnabled && audioAthan.src) { audioAthan.currentTime=0; audioAthan.play(); } else alert('ÙØ¹Ù‘Ù„ Ø§Ù„ØµÙˆØª ÙˆØ¹ÙŠÙ‘Ù† Ù…Ù„ÙÙ‹Ø§ Ø£ÙˆÙ„Ù‹Ø§.'); };
    el('testIqama').onclick = ()=>{ if(state.audioEnabled && audioIqama.src) { audioIqama.currentTime=0; audioIqama.play(); } else alert('ÙØ¹Ù‘Ù„ Ø§Ù„ØµÙˆØª ÙˆØ¹ÙŠÙ‘Ù† Ù…Ù„ÙÙ‹Ø§ Ø£ÙˆÙ„Ù‹Ø§.'); };
    el('clearAthan').onclick = async ()=>{ try{ await idbDelete('ptt_audioAthan'); await loadAudios(); status('ØªÙ… Ø­Ø°Ù ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù†'); if(state.cloud.enabled) await fb.db.ref(getRefs().media).update({athanUrl:null}); }catch{} };
    el('clearIqama').onclick = async ()=>{ try{ await idbDelete('ptt_audioIqama'); await loadAudios(); status('ØªÙ… Ø­Ø°Ù ØµÙˆØª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©'); if(state.cloud.enabled) await fb.db.ref(getRefs().media).update({iqamaUrl:null}); }catch{} };

    // Ø§Ù„Ø«ÙŠÙ…
    el('googleFontUrl').value = state.ui.googleFontUrl || '';
    el('accent').value = state.ui.colors.accent; el('accent2').value = state.ui.colors.accent2; el('bg').value = state.ui.colors.bg; el('textColor').value = state.ui.colors.text;
    el('phaseAthanColor').value = state.ui.colors.phaseAthan || '#60a5fa';
    el('phaseIqamaColor').value = state.ui.colors.phaseIqama || '#fbbf24';
    el('phaseGraceColor').value = state.ui.colors.phaseGrace || '#a8b3cf';
    el('bgImage').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ await idbSet('ptt_bgImage', f); await loadBgFromStore(); status('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©'); if(state.cloud.enabled) await uploadToStorage(f, 'bg'); } catch(err){ alert('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸/Ø±ÙØ¹ Ø§Ù„Ø®Ù„ÙÙŠØ©.'); } });
    el('clearBg').onclick = async ()=>{ try{ await idbDelete('ptt_bgImage'); await loadBgFromStore(); status('ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©'); if(state.cloud.enabled) await fb.db.ref(getRefs().media).update({bgUrl:null}); }catch{} };

    // Ø§Ù„ÙˆÙ‚Øª
    el('timeFormat').value = state.ui.timeFormat || '12'; el('tzOffset').value = state.ui.tzOffset || 0;

    // Cloud controls
    el('cloudEnabled').value = state.cloud.enabled ? 'on' : 'off';
    el('roomId').value = state.cloud.roomId || 'default';
    const cfg = state.cloud.config||{}; el('fb_apiKey').value = cfg.apiKey||''; el('fb_authDomain').value=cfg.authDomain||''; el('fb_databaseURL').value=cfg.databaseURL||''; el('fb_storageBucket').value=cfg.storageBucket||'';

    el('fbConnect').onclick = ()=>{ state.cloud.config = { apiKey:el('fb_apiKey').value.trim(), authDomain:el('fb_authDomain').value.trim(), databaseURL:el('fb_databaseURL').value.trim(), storageBucket:normalizeBucket(el('fb_storageBucket').value.trim()) }; saveLS('ptt_cloud', state.cloud); if(initFirebase()) cloudStatus('Ø¬Ø§Ù‡Ø²'); };
    el('fbLogin').onclick = ()=>{ state.cloud.email = el('fb_email').value.trim(); state.cloud.password = el('fb_password').value; saveLS('ptt_cloud', state.cloud); fbLogin(); };
    el('fbLogout').onclick = fbLogout;
    el('fbTest').onclick = ()=>{ if(!initFirebase()) return; try{ const testRef = fb.db.ref(getRefs().base+'/ping'); testRef.set(Date.now()).then(()=> cloudStatus('Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª OK (ÙƒØªØ§Ø¨Ø©)')).catch(e=> cloudStatus('Ø§ØªØµØ§Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© OK â€” Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙØ´Ù„Øª: '+(e?.code||e?.message))); }catch(e){ cloudStatus('ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'); } };

    el('enableAudioBtn').onclick = enableAudio; el('enableAudioFloating').onclick = enableAudio;
    el('openScreen').onclick = ()=>{
      const params = new URLSearchParams({screen: '1', autoplay: '1'});
      if(state.cloud.enabled){
        params.set('cloud','1'); params.set('room', state.cloud.roomId || 'default');
        const c=state.cloud.config||{}; if(c.apiKey) params.set('apiKey', c.apiKey); if(c.authDomain) params.set('authDomain', c.authDomain); if(c.databaseURL) params.set('databaseURL', c.databaseURL); if(c.storageBucket) params.set('storageBucket', c.storageBucket);
      }
      window.open(location.pathname + '?' + params.toString(), '_blank');
    };

    el('openSettings').onclick = ()=>{ el('settings').classList.toggle('hidden'); };

    el('saveSettings').onclick = ()=>{
      state.offsets = { Fajr: +el('offFajr').value||0, Dhuhr:+el('offDhuhr').value||0, Asr:+el('offAsr').value||0, Maghrib:+el('offMaghrib').value||0, Isha:+el('offIsha').value||0 };
      saveLS('ptt_offsets', state.offsets);
      state.ui.googleFontUrl = el('googleFontUrl').value.trim();
      state.ui.colors = { accent: el('accent').value, accent2: el('accent2').value, bg: el('bg').value, text: el('textColor').value, phaseAthan: el('phaseAthanColor').value, phaseIqama: el('phaseIqamaColor').value, phaseGrace: el('phaseGraceColor').value };
      state.ui.timeFormat = el('timeFormat').value; state.ui.tzOffset = parseInt(el('tzOffset').value||'0',10); state.ui.graceMin = Math.max(0, parseInt(el('graceMin').value||'0',10));
      saveLS('ptt_ui', state.ui); applyTheme(); renderTodayPills(); status('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'); if(state.cloud.enabled) pushToCloud({offsets:true, ui:true});
    };

    el('cloudEnabled').addEventListener('change', (e)=>{ state.cloud.enabled = e.target.value==='on'; state.cloud.roomId = el('roomId').value.trim() || 'default'; saveLS('ptt_cloud', state.cloud); if(state.cloud.enabled){ subscribeCloud(); pushToCloud({schedule:true, offsets:true, ui:true}); } else if(fb.unsub){ fb.unsub(); } cloudStatus(state.cloud.enabled? 'Ù…ÙØ¹Ù‘Ù„' : 'Ù…ØªÙˆÙ‚Ù'); });
    el('roomId').addEventListener('change', ()=>{ state.cloud.roomId = el('roomId').value.trim()||'default'; saveLS('ptt_cloud', state.cloud); if(state.cloud.enabled){ subscribeCloud(); pushToCloud({schedule:true, offsets:true, ui:true}); } });

    el('exportData').onclick = ()=>{ const blob=new Blob([JSON.stringify({schedule:state.schedule, offsets:state.offsets, ui:state.ui}, null, 2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='prayer-tracker-backup.json'; a.click(); URL.revokeObjectURL(url); };
    el('exportWithMedia').onclick = async ()=>{ const data={schedule:state.schedule, offsets:state.offsets, ui:state.ui, media:{}}; try{ const a=await idbGet('ptt_audioAthan'); if(a) data.media.audioAthan=await blobToDataURL(a); const q=await idbGet('ptt_audioIqama'); if(q) data.media.audioIqama=await blobToDataURL(q); const bg=await idbGet('ptt_bgImage'); if(bg) data.media.bgImage=await blobToDataURL(bg);}catch(e){} const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='prayer-tracker-backup-with-media.json'; a.click(); URL.revokeObjectURL(url); };
    el('importData').onclick = ()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json'; inp.onchange = e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=async ()=>{ try{ const data=JSON.parse(r.result); if(data.schedule){ state.schedule=sanitizeScheduleForFirebase(data.schedule); saveLS('ptt_schedule',state.schedule); } if(data.offsets){ state.offsets=data.offsets; saveLS('ptt_offsets',state.offsets); } if(data.ui){ state.ui={...state.ui,...data.ui}; saveLS('ptt_ui',state.ui); } if(data.media){ if(data.media.audioAthan){ const b=dataURLtoBlob(data.media.audioAthan); if(b) await idbSet('ptt_audioAthan', b); } if(data.media.audioIqama){ const b=dataURLtoBlob(data.media.audioIqama); if(b) await idbSet('ptt_audioIqama', b); } if(data.media.bgImage){ const b=dataURLtoBlob(data.media.bgImage); if(b) await idbSet('ptt_bgImage', b); } } await loadAudios(); await loadBgFromStore(); applyTheme(); renderTable(); renderTodayPills(); status('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); if(state.cloud.enabled) pushToCloud({schedule:true, offsets:true, ui:true}); }catch(e){ alert('Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­'); } }; r.readAsText(f); }; inp.click(); };

    el('resetAll').onclick = async ()=>{ if(!confirm('Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø­Ù„ÙŠÙ‹Ø§). Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return; localStorage.removeItem('ptt_schedule'); localStorage.removeItem('ptt_offsets'); localStorage.removeItem('ptt_audioFlags'); localStorage.removeItem('ptt_ui'); localStorage.removeItem('ptt_cloud'); await idbClear(); location.reload(); };

    el('runTests').onclick = runSelfTests;
    el('showUsage').onclick = showStorageUsage;
    el('clearIDB').onclick = async ()=>{ await idbClear(); alert('ØªÙ… Ù…Ø³Ø­ IndexedDB.'); };

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø¯ÙØ¹
    el('pushAll').onclick = ()=>{ pushToCloud({schedule:true, offsets:true, ui:true}); };
    el('pullAll').onclick = ()=>{ if(!initFirebase()) return; const r=getRefs(); Promise.all([
      fb.db.ref(r.schedule).once('value'),
      fb.db.ref(r.offsets).once('value'),
      fb.db.ref(r.ui).once('value')
    ]).then(([s,o,u])=>{
      if(s.exists()){ state.schedule=sanitizeScheduleForFirebase(s.val()); saveLS('ptt_schedule',state.schedule); }
      if(o.exists()){ state.offsets=o.val(); saveLS('ptt_offsets',state.offsets); }
      if(u.exists()){ state.ui={...state.ui, ...u.val()}; saveLS('ptt_ui',state.ui); applyTheme(); }
      renderTable(); renderTodayPills(); status('ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
    }).catch(e=>{ alert('ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: '+(e?.message||e)); }); };
  }

  // ======= Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª =======
  async function runSelfTests(){
    const out=[]; const ok=(name,cond)=>out.push(`${cond?'âœ…':'âŒ'} ${name}`);
    const d='2025-01-01'; ok('ØªØ­Ù„ÙŠÙ„ 12Øµ', parseTimeToDate(d,'12:00 Øµ').getHours()===0); ok('ØªØ­Ù„ÙŠÙ„ 12Ù…', parseTimeToDate(d,'12:00 Ù…').getHours()===12); ok('ØªØ­Ù„ÙŠÙ„ 24h 23:59', parseTimeToDate(d,'23:59').getHours()===23); ok('ØªÙ†Ø³ÙŠÙ‚ 12h', fmtClock(new Date('2025-01-01T13:05:00'),'12')==='1:05 Ù…'); ok('ØªÙ†Ø³ÙŠÙ‚ 24h', fmtClock(new Date('2025-01-01T09:07:00'),'24')==='09:07');
    // Sanitizers
    ok('sanitizeDateKey basic', sanitizeDateKey('2025-08-10]')==='2025-08-10');
    ok('sanitizeDateKey slashes', sanitizeDateKey(' 2025/08/10 ')==='2025-08-10');
    const schBad={ '2025-08-10]':{Fajr:'04:00 Øµ'}, 'x':{Fajr:'04:00 Øµ'} };
    const schGood=sanitizeScheduleForFirebase(schBad); ok('sanitizeScheduleForFirebase', Object.keys(schGood).length===1 && schGood['2025-08-10']);
    el('testOutput').textContent = out.join('\n');
  }

  async function showStorageUsage(){ const lsBytes = new Blob([JSON.stringify(localStorage)]).size; const a=await idbGet('ptt_audioAthan'); const q=await idbGet('ptt_audioIqama'); const bg=await idbGet('ptt_bgImage'); const idbBytes=(a?.size||0)+(q?.size||0)+(bg?.size||0); el('testOutput').textContent = `LocalStorageâ‰ˆ ${lsBytes} bytes; IndexedDB mediaâ‰ˆ ${idbBytes} bytes`; }

  // ======= Ø¥Ù‚Ù„Ø§Ø¹ =======
  (async function(){
    if(SCREEN) document.body.classList.add('screen');
    applyUrlParams();
    await migrateIfNeeded();
    applyTheme();
    initControls();
    renderTable();
    renderTodayPills();
    await loadAudios();
    updateFloatingAudio();
    start();
    if (SCREEN && AUTO_AUDIO) {
  const tryEnable = ()=>{ try { enableAudio(); } catch(_){} };
  setTimeout(tryEnable, 300);
  setTimeout(tryEnable, 1500);
}
    if(state.cloud.enabled){
      if(initFirebase()){
        const p = new URLSearchParams(location.search);
        if((p.get('autologin')||'0')!=='0' && state.cloud.email && state.cloud.password){ await fbLogin(); }
        subscribeCloud();
      }
    }
  })();
  </script>
</body>
</html>
